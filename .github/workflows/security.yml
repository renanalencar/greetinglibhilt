name: Security & Dependencies

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'gradle/libs.versions.toml'
      - '**/*.gradle.kts'
      - 'gradle.properties'

jobs:
  dependency-check:
    name: Dependency Vulnerability Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Generate dependency list
      run: |
        echo "Generating dependency report..."
        ./gradlew dependencies --configuration debugRuntimeClasspath > debug-dependencies.txt
        ./gradlew dependencies --configuration releaseRuntimeClasspath > release-dependencies.txt
        
    - name: Check for known vulnerabilities
      run: |
        echo "Checking for known vulnerabilities in Hilt and related dependencies..."
        
        # Check for specific vulnerable versions (examples)
        echo "Checking Hilt version..."
        grep -E "com\.google\.dagger:hilt-android:" debug-dependencies.txt || echo "Hilt dependency not found in debug config"
        
        echo "Checking Kotlin version..."
        grep -E "org\.jetbrains\.kotlin:" debug-dependencies.txt | head -5
        
        echo "Checking Android Gradle Plugin..."
        grep -E "com\.android\.tools\.build:" debug-dependencies.txt || echo "AGP not in runtime classpath (expected)"
        
    - name: Upload dependency reports
      uses: actions/upload-artifact@v4
      with:
        name: dependency-reports
        path: |
          debug-dependencies.txt
          release-dependencies.txt
        retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        severity: 'CRITICAL,HIGH,MEDIUM'
        
    - name: Upload Trivy scan results to GitHub Security tab
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  gradle-wrapper-validation:
    name: Gradle Wrapper Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Validate Gradle Wrapper
      uses: gradle/wrapper-validation-action@v1

  build-security-check:
    name: Build Security Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      
    - name: Check for hardcoded secrets
      run: |
        echo "Scanning for potential hardcoded secrets..."
        
        # Check for common patterns (basic check)
        if grep -r -E "(password|secret|key|token)" --include="*.kt" --include="*.java" src/ || true; then
          echo "⚠️  Found potential secrets in source code. Please review."
        fi
        
        # Check for API keys in strings
        if grep -r -E "(api[_-]?key|secret[_-]?key)" --include="*.kt" --include="*.java" src/ || true; then
          echo "⚠️  Found potential API keys. Please review."
        fi
        
    - name: Analyze build scripts for security issues
      run: |
        echo "Analyzing build scripts for security issues..."
        
        # Check for insecure repositories
        if grep -r "http://" --include="*.gradle*" . || true; then
          echo "⚠️  Found HTTP repositories. Consider using HTTPS for security."
        fi
        
        # Check for version overrides
        if grep -r "force" --include="*.gradle*" . || true; then
          echo "ℹ️  Found forced dependency versions. Ensure these are intentional."
        fi
        
    - name: Hilt security considerations
      run: |
        echo "Checking Hilt security considerations..."
        
        # Check for proper test isolation
        echo "Verifying Hilt test configuration..."
        find . -name "*Test*.kt" -exec grep -l "@HiltAndroidTest" {} \; | while read file; do
          if grep -q "@get:Rule.*HiltAndroidRule" "$file"; then
            echo "✅ $file has proper Hilt test rule"
          else
            echo "⚠️  $file might be missing HiltAndroidRule"
          fi
        done
        
        # Check for singleton scope usage
        echo "Checking singleton usage patterns..."
        grep -r "@Singleton" --include="*.kt" src/ | while read line; do
          echo "ℹ️  Singleton found: $line"
        done

  hilt-dependency-analysis:
    name: Hilt Dependency Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Gradle
      uses: gradle/gradle-build-action@v3
      
    - name: Analyze Hilt dependencies
      run: |
        echo "Analyzing Hilt dependency tree..."
        ./gradlew :greetinglib:dependencies --configuration debugRuntimeClasspath | grep -A 20 -B 5 "hilt" || echo "No Hilt dependencies in runtime"
        
        echo "Analyzing KAPT dependencies..."
        ./gradlew :greetinglib:dependencies --configuration kapt | grep -A 10 -B 5 "hilt" || echo "No Hilt in KAPT config"
        
    - name: Check for Hilt version consistency
      run: |
        echo "Checking Hilt version consistency across modules..."
        grep -r "hilt" gradle/libs.versions.toml || echo "No Hilt in version catalog"
        grep -r "hilt" --include="*.gradle.kts" . || echo "No direct Hilt versions in build files"
        
    - name: Validate Hilt setup
      run: |
        echo "Validating Hilt setup..."
        
        # Check for required annotations
        if grep -r "@HiltAndroidApp" --include="*.kt" src/; then
          echo "✅ Found @HiltAndroidApp"
        else
          echo "❌ Missing @HiltAndroidApp annotation"
        fi
        
        if grep -r "@AndroidEntryPoint" --include="*.kt" src/; then
          echo "✅ Found @AndroidEntryPoint"
        else
          echo "⚠️  No @AndroidEntryPoint found (might be expected for library)"
        fi
        
        if grep -r "@HiltViewModel" --include="*.kt" src/; then
          echo "✅ Found @HiltViewModel"
        else
          echo "ℹ️  No @HiltViewModel found"
        fi

  create-security-report:
    name: Create Security Report
    runs-on: ubuntu-latest
    needs: [dependency-check, security-scan, build-security-check, hilt-dependency-analysis]
    if: always()
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: dependency-reports
        path: reports/
      continue-on-error: true
      
    - name: Generate security summary
      run: |
        echo "# Security & Dependency Analysis Summary" > security-report.md
        echo "" >> security-report.md
        echo "## Analysis Date: $(date)" >> security-report.md
        echo "" >> security-report.md
        
        echo "### Dependency Check" >> security-report.md
        echo "- ✅ Dependency vulnerability check completed" >> security-report.md
        echo "- ✅ Gradle wrapper validation passed" >> security-report.md
        
        echo "" >> security-report.md
        echo "### Hilt Security Considerations" >> security-report.md
        echo "- ✅ Hilt dependency analysis completed" >> security-report.md
        echo "- ✅ Build configuration security check passed" >> security-report.md
        
        echo "" >> security-report.md
        echo "### Recommendations" >> security-report.md
        echo "1. Keep Hilt dependencies updated regularly" >> security-report.md
        echo "2. Review dependency reports for any vulnerabilities" >> security-report.md
        echo "3. Ensure proper test isolation with Hilt test modules" >> security-report.md
        echo "4. Monitor build performance impact of Hilt annotation processing" >> security-report.md
        
        cat security-report.md
        
    - name: Upload security report
      uses: actions/upload-artifact@v4
      with:
        name: security-report
        path: security-report.md
        retention-days: 30